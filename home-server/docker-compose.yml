version: "3.8"

services:
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: sotto-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./services/mqtt-broker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mqtt-data:/mosquitto/data
      - mqtt-log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 10s
      timeout: 5s
      retries: 3

  ollama:
    image: ollama/ollama:latest
    container_name: sotto-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        reservations:
          memory: 4G

  transcription:
    build:
      context: ./services
      dockerfile: transcription/Dockerfile
    container_name: sotto-transcription
    restart: unless-stopped
    depends_on:
      mqtt-broker:
        condition: service_healthy
    environment:
      MQTT_HOST: mqtt-broker
      MQTT_PORT: "1883"
      WHISPER_MODEL: ${WHISPER_MODEL:-base}
      WHISPER_DEVICE: ${WHISPER_DEVICE:-auto}

  agent-brain:
    build:
      context: ./services
      dockerfile: agent-brain/Dockerfile
    container_name: sotto-agent-brain
    restart: unless-stopped
    depends_on:
      mqtt-broker:
        condition: service_healthy
      ollama:
        condition: service_healthy
    environment:
      MQTT_HOST: mqtt-broker
      MQTT_PORT: "1883"
      OLLAMA_URL: http://ollama:11434
      OLLAMA_MODEL: ${OLLAMA_MODEL:-llama3.1:8b}
      DB_PATH: /data/sotto.db
      VAULT_PATH: /data/vault
    volumes:
      - sotto-data:/data

  tts:
    build:
      context: ./services
      dockerfile: tts/Dockerfile
    container_name: sotto-tts
    restart: unless-stopped
    depends_on:
      mqtt-broker:
        condition: service_healthy
    environment:
      MQTT_HOST: mqtt-broker
      MQTT_PORT: "1883"
      PIPER_MODEL: ${PIPER_MODEL:-}
    volumes:
      - piper-models:/models

volumes:
  mqtt-data:
  mqtt-log:
  ollama-models:
  sotto-data:
  piper-models:
